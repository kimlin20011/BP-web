<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Container Data</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="bower_components/moment/moment.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.3/daterangepicker.css"/>
    <script type="text/javascript" src="bower_components/DataTables/datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bower_components/DataTables/datatables.min.css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <!--<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>-->
    <!--<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>-->
    <!--<![endif]&ndash;&gt;-->
    <!-- Google Font -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    <style>
        .gm-style-iw + div {
            display: none;
        }

        .gm-style-iw {
            text-align: center;
        }
    </style>

</head>
<!-- ADD THE CLASS layout-top-nav TO REMOVE THE SIDEBAR. -->

<body class="hold-transition skin-blue layout-top-nav">
<div class="wrapper">
    <header class="main-header">
        <nav class="navbar navbar-static-top">
            <div class="container">
                <div class="navbar-header">
                    <a href="#" class="navbar-brand"><b>Container</b>Data</a>
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                            data-target="#navbar-collapse">
                        <i class="fa fa-bars"></i>
                    </button>
                </div>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-right" id="navbar-collapse">
                    <!-- <ul class="nav navbar-nav">

        <li><a href="#">Link</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li class="divider"></li>
            <li><a href="#">Separated link</a></li>
            <li class="divider"></li>
            <li><a href="#">One more separated link</a></li>
          </ul>
        </li>
      </ul> -->
                    <form action="#" method="get" class="navbar-form " role="search">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" id="navbar-search-input"
                                   placeholder="device-id">
                            <span class="input-group-btn">
                  <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
                  </button>
                </span>
                        </div>
                    </form>
                </div>
                <!-- /.navbar-collapse -->
            </div>
            <!-- /.container-fluid -->
        </nav>
    </header>
    <!-- Full Width Column -->
    <div class="content-wrapper">
        <div class="container">
            <!-- Content Header (Page header) -->
            <section class="content-header">
            </section>
            <div><h1><%= title %></h1></div>
            <div class="box box-primary">
                <div class="box-body">
                    <!-- Date and time range -->
                    <label>查詢時間區間</label>
                    <div class="form-group">
                        <form action="#" method="get" role="search">
                            <!-- <label>Date and time range:</label> -->
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <input type="text" class="form-control pull-right" id="reservationtime"
                                       name="datetimes">
                                <span class="input-group-btn">
                                <button type="submit" name="search" id="search-btn" class="btn btn-flat"
                                        style="background-color:#3c8dbc; color:#ffffff"><i class="fa fa-search"></i>
                                </button>
                              </span>
                            </div>
                            <!-- /.input group -->
                        </form>
                    </div>
                    <!-- /.form group -->
                    <!-- Date and time range -->
                </div>
                <!-- /.box-body -->
            </div>
            <div class="box box-success">
                <div class="box-header">
                    <h3 class="box-title">運送路徑資訊</h3>
                </div>
                <div id="map" style="height: 500px; margin: 0px; padding: 0px;" class="box-body"></div>

            </div>
            <div class="box box-warning">
                <div class="box-header with-border">
                    <h3 class="box-title">溫濕度圖表</h3>
                </div>
                <div class="box-body">
                    <div class="chart">
                        <canvas id="areaChart" style="height: 249px; width: 675px;" width="1350" height="498"></canvas>
                    </div>
                </div>
                <!-- /.box-body -->
            </div>
            <div class="box box-danger">
                <table id="example" class="display" width="100%"></table>
            </div>

            <!-- Main content -->
        </div>
        <!-- /.container -->
    </div>
    <!-- /.content-wrapper -->
</div>


<!-- ./wrapper -->

<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAprpUrbF7bXWIzEKLF0s8sRMi4lqs7uY8&callback=initMap">
</script>
<script>


    var marker;

    function initMap() {
        var myLatLng = {lat: 24.987088, lng: 121.573474};

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 16,
            center: myLatLng
        });

        marker = new google.maps.Marker({
            map: map,
            // draggable: true,
            animation: google.maps.Animation.DROP,
            position: myLatLng,
        });

        var infowindow = new google.maps.InfoWindow({
            content: '<div id="content">' +
                '<h1 id="firstHeading" class="firstHeading">Uluru</h1>' +
                '</div>'
        });

        // marker.addListener('click', toggleBounce);
        marker.addListener('mouseover', function () {
            infowindow.open(map, marker);
            toggleBounce()
        });
        marker.addListener('mouseout', function () {
            infowindow.close();
        });
    }


    // function toggleBounce() {
    //     if (marker.getAnimation() !== null) {
    //         marker.setAnimation(null);
    //     } else {
    //         marker.setAnimation(google.maps.Animation.BOUNCE);
    //     }
    // }


    $(function () {
        $('input[name="datetimes"]').daterangepicker({
            timePicker: true,
            startDate: moment().startOf('hour'),
            endDate: moment().startOf('hour').add(32, 'hour'),
            locale: {
                format: 'M/DD hh:mm A'
            }
        });
    });

    $(function(){
        var dataSet = [];
        var labels = [];
        var temperatures = [];
        var humiditys = [];
        var flickerAPI = 'http://192.168.4.206:3000';
        //將資料用ajax抓取後動態顯示在前端
        $.getJSON(flickerAPI,  function(data) {
            console.log(data);

            for(var k in data) {
                console.log(k, data[k]);
                dataSet.push([data[k].pi_mac,data[k].timestamp,Number(data[k].lat)+0.394613,Number(data[k].lng)+0.229376,data[k].temperature,data[k].humidity]);
                labels.push(data[k].timestamp);
                temperatures.push(data[k].temperature);
                humiditys.push(data[k].humidity);
            }
            console.log(dataSet)

            $(document).ready(function() {
                $('#example').DataTable( {
                    data: dataSet,
                    columns: [
                        { title: "pi_mac" },
                        { title: "timestamp" },
                        { title: "lat" },
                        { title: "lng" },
                        { title: "temperature" },
                        { title: "humidity" }
                    ]
                } );
            } );


            initMap(dataSet)

            function initMap(dataSet) {
                var myLatLng = {lat: 24.987088, lng: 121.573474};

                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 20,
                    center: myLatLng
                });
                setMarkers(map, dataSet)
            }
            function setMarkers(map,_dataSet){


                var marker, i


                for (i = 0; i < _dataSet.length; i++) {
                    doSetTimeout(i);
                }

                function doSetTimeout(i) {
                    setTimeout(function() {
                        var timestamp = _dataSet[i][1]
                        var lat = _dataSet[i][2]
                        var long = _dataSet[i][3]

                        latlngset = new google.maps.LatLng(lat, long);

                        marker = new google.maps.Marker({
                            map: map,
                            title: timestamp,
                            position: latlngset,
                            animation: google.maps.Animation.DROP,
                        });
                        map.setCenter(marker.getPosition())

                        var content = '</h3>'+"timestamp: " + timestamp + '</h3>';

                        var infowindow = new google.maps.InfoWindow()

                        google.maps.event.addListener(marker,'mouseover', (function(marker,content,infowindow){
                            return function() {
                                infowindow.setContent(content);
                                infowindow.open(map,marker);
                                toggleBounce(marker)
                            };
                        })(marker,content,infowindow));

                        google.maps.event.addListener(marker,'mouseout', (function(marker,content,infowindow){
                            return function() {
                                infowindow.close(map,marker);
                                toggleBounce(marker)
                            };
                        })(marker,content,infowindow));
                        }, i*100);
                }


            }

            //製造跳動效果 暫時沒用
            function toggleBounce(marker) {
                if (marker.getAnimation() !== null) {
                    marker.setAnimation(null);
                } else {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }
            }


            /* ChartJS
         * -------
         * Here we will create a few charts using ChartJS
         */

            //--------------
            //- AREA CHART -
            //--------------

            // Get context with jQuery - using jQuery's .get() method.
            var areaChartCanvas = $('#areaChart').get(0).getContext('2d')
            // This will get the first returned node in the jQuery collection.
            var areaChart = new Chart(areaChartCanvas)
            var areaChartData = {
                labels: labels,
                datasets: [{
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "rgba(220,220,220,1)",
                    pointColor: "rgba(220,220,220,1)",
                    pointStrokeColor: "#fff",
                    data: temperatures

                },
                    {
                        label: 'Digital Goods',
                        fillColor: "rgba(151,187,205,0.5)",
                        strokeColor: "rgba(151,187,205,1)",
                        pointColor: "rgba(151,187,205,1)",
                        pointStrokeColor: "#fff",
                        data: humiditys

                    }
                ]
            }

            //Create the line chart
            areaChart.Line(areaChartData)







        })
    });



</script>
<!-- jQuery 3 -->
<!-- <script src="bower_components/jquery/dist/jquery.min.js"></script> -->
<!-- Bootstrap 3.3.7 -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="bower_components/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
<!-- ChartJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.js"></script>
</body>

</html>